# k8s infra

## Manage

### Deploy Infra
```bash
./deploy.sh 2200 2>&1 | tee "log/deploy $(date).log"
```
### Destroy Infra
```bash
./destroy.sh 2>&1 | tee "log/destroy $(date).log"
``` 

vagrant ```node.trigger.after :up``` remotely executes "sync/scripts/salt_init.sh".
The script calls salt to apply the active configurations to specified VMs in the infrastructure. Salt itself is deployed by the builtin salt provisioner that comes included with vagrant.

>NOTE: The Salt provisioner is builtin to Vagrant. If the vagrant-salt plugin is installed, it should be uninstalled to ensure expected behavior.
> - [Documentation](https://www.vagrantup.com/docs/provisioning/salt)

Keys for salt are pre generated by gen_salt_keys.sh and packaged with the rest of the files. Automating regeneration is not implemented.

Using a bash script to controll salt appears to be a quicker solution to using the requisites mechanism and simplifies reusability.

## Dashboard

Installed with a working and accesible dashboard via salt & bash scripts using the kubeadm method to setup a single host cluster.
admin token available in ```sync/k8s/admin-user-token.txt```.

```bash
grep -E "^token:" sync/k8s/admin-user-token.txt | tr -s " " | cut -d " " -f 2
```

Manually run the proxy from main with ```kubectl proxy --address="{virtualbox_nat_ip}"``` VM:
```bash
kubectl proxy --address="10.0.2.15" # in my case
```
```bash
kubectl proxy --address="0.0.0.0" # or listen on all available but with some potential unwanted side effects
```
```bash
ip address show | grep -E " inet .*/24" | tr -s " " | cut -d " " -f 3 | cut -d "/" -f 1 # List available IPv4 addresses
ip address show | grep -E " inet .*/24" | tr -s " " | cut -d " " -f 3 | cut -d "/" -f 1 | sed -n -e "1{p;q;}" # Get the first address
```
```bash
kubectl proxy --address="$(ip address show | grep -E " inet .*/24" | tr -s " " | cut -d " " -f 3 | cut -d "/" -f 1 | sed -n -e "1{p;q;}")"
```
[k8s Dashboard](http://localhost:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/)

[k8s Dashboard NodePort](https://192.168.120.100:30080) should work without the proxy.

## Set local kubectl

```bash
source <(kubectl completion bash)
scp -P 2222 vagrant@localhost:/home/vagrant/.kube/config ~/.kube/config
```
