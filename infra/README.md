# k8s infra

## Deploy

Bring up and down with following.

```bash
./deploy.sh 2>&1 | tee "log/deploy $(date).log"
./destroy.sh 2>&1 | tee "log/destroy $(date).log"
``` 

vagrant ```node.trigger.after :up``` remotely executes "sync/scripts/salt_init.sh".
The script calls salt to apply the active configurations to specified VMs in the infrastructure. Salt itself is deployed by the builtin salt provisioner that comes included with vagrant.

>NOTE: The Salt provisioner is builtin to Vagrant. If the vagrant-salt plugin is installed, it should be uninstalled to ensure expected behavior.
> - [Documentation](https://www.vagrantup.com/docs/provisioning/salt)

Keys for salt are pre generated by gen_salt_keys.sh and packaged with the rest of the files. Automating regeneration is not implemented.

Using a bash script to controll salt appears to be a quicker solution to using the requisites mechanism and simplifies reusability.

## Dashboard

Installed with a working and accesible dashboard via salt & bash scripts using the kubeadm method to setup a single host cluster.
admin token available in ```sync/k8s/admin-user-token.txt

Manually run from the VM

```bash
kubectl proxy --address="{virtualbox_nat_ip}"
# eg kubectl proxy --address="10.0.2.15"
```

[k8s Dashboard](http://localhost:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/)

## Set local kubectl

```bash
source <(kubectl completion bash)
scp -P 2222 vagrant@localhost:/home/vagrant/.kube/config ~/.kube/config
```
